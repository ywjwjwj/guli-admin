{"version":3,"file":"affix.js","sources":["../../src/affix/affix.tsx"],"sourcesContent":["import Vue, { VueConstructor } from 'vue';\nimport isFunction from 'lodash/isFunction';\nimport { prefix } from '../config';\nimport { on, off, getScrollContainer } from '../utils/dom';\nimport affixProps from './props';\nimport { ScrollContainerElement } from '../common';\n\nconst name = `${prefix}-affix`;\nexport interface Affix extends Vue {\n  scrollContainer: ScrollContainerElement;\n  ticking: boolean;\n  containerHeight: number;\n}\n\nexport default (Vue as VueConstructor<Affix>).extend({\n  name: 'TAffix',\n  props: {\n    ...affixProps,\n  },\n  data() {\n    return {\n      fixedTop: false as false | number,\n      oldWidthHeight: { width: '0px', height: '0px' },\n    };\n  },\n  watch: {\n    offsetTop() {\n      this.calcInitValue();\n    },\n    offsetBottom() {\n      this.calcInitValue();\n    },\n  },\n  methods: {\n    handleScroll() {\n      if (!this.ticking) {\n        window.requestAnimationFrame(() => {\n          const { top } = this.$el.getBoundingClientRect(); // top = 节点到页面顶部的距离，包含 scroll 中的高度\n          let containerTop = 0; // containerTop = 容器到页面顶部的距离\n          if (this.scrollContainer instanceof HTMLElement) {\n            containerTop = this.scrollContainer.getBoundingClientRect().top;\n          }\n          const calcTop = top - containerTop; // 节点顶部到 container 顶部的距离\n          const calcBottom = containerTop + this.containerHeight - this.offsetBottom; // 计算 bottom 相对应的 top 值\n          if (this.offsetTop !== undefined && calcTop <= this.offsetTop) {\n            // top 的触发\n            this.fixedTop = containerTop + this.offsetTop;\n          } else if (this.offsetBottom !== undefined && top >= calcBottom) {\n            // bottom 的触发\n            this.fixedTop = calcBottom;\n          } else {\n            this.fixedTop = false;\n          }\n          this.ticking = false;\n          this.$emit('fixedChange', this.fixedTop !== false, { top: this.fixedTop });\n          if (isFunction(this.onFixedChange)) this.onFixedChange(this.fixedTop !== false, { top: this.fixedTop });\n        });\n        this.ticking = true;\n      }\n    },\n    calcInitValue() {\n      const { scrollContainer } = this;\n      // 获取当前可视的高度\n      const containerHeight = scrollContainer[scrollContainer instanceof Window ? 'innerHeight' : 'clientHeight'];\n      // 需要减掉当前节点的高度，对比的高度应该从 border-top 比对开始\n      this.containerHeight = containerHeight - this.$el.clientHeight;\n      // 被包裹的子节点宽高\n      const { clientWidth, clientHeight } = this.$el.querySelector(`.${name}`) || this.$el;\n      this.oldWidthHeight = { width: `${clientWidth}px`, height: `${clientHeight}px` };\n\n      this.handleScroll();\n    },\n  },\n  async mounted() {\n    await this.$nextTick();\n    this.scrollContainer = getScrollContainer(this.container);\n    this.calcInitValue();\n    on(this.scrollContainer, 'scroll', this.handleScroll);\n    on(window, 'resize', this.calcInitValue);\n    if (!(this.scrollContainer instanceof Window)) on(window, 'scroll', this.handleScroll);\n  },\n  destroyed() {\n    if (!this.scrollContainer) return;\n    off(this.scrollContainer, 'scroll', this.handleScroll);\n    off(window, 'resize', this.calcInitValue);\n    if (!(this.scrollContainer instanceof Window)) off(window, 'scroll', this.handleScroll);\n  },\n  render() {\n    const {\n      $slots: { default: children },\n      oldWidthHeight,\n      fixedTop,\n      zIndex,\n    } = this;\n\n    // false 0 -1 1 都用实际的意义\n    if (fixedTop !== false) {\n      return (\n        <div>\n          <div style={oldWidthHeight}></div>\n          <div class={name} style={{ zIndex, top: `${fixedTop}px`, width: oldWidthHeight.width }}>\n            {children}\n          </div>\n        </div>\n      );\n    }\n\n    return <div>{children}</div>;\n  },\n});\n"],"names":["name","prefix","Vue","extend","props","affixProps","data","fixedTop","oldWidthHeight","width","height","watch","offsetTop","calcInitValue","offsetBottom","methods","handleScroll","ticking","window","requestAnimationFrame","$el","getBoundingClientRect","top","containerTop","scrollContainer","HTMLElement","calcTop","calcBottom","containerHeight","$emit","isFunction","onFixedChange","Window","clientHeight","querySelector","clientWidth","mounted","_asyncToGenerator","_regeneratorRuntime","$nextTick","getScrollContainer","container","on","destroyed","off","render","children","$slots","zIndex"],"mappings":"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"}